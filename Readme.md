# Kubernetes Cluster Setup Using Kubeadm

This guide provides step-by-step instructions for setting up a Kubernetes cluster using `kubeadm` on Ubuntu 22.04.

## Prerequisites

- Ubuntu 22.04 installed on all nodes (1 master and 2+ worker nodes)
- User with sudo privileges
- Internet connection
- `kubeadm`, `kubelet`, and `kubectl` installed on all nodes

## Step 1: Prepare the Servers

1. **Update the package index and install necessary packages:**

    ```sh
    sudo apt-get update
    sudo apt-get install -y apt-transport-https ca-certificates curl
    ```

2. **Disable swap:**

    ```sh
    sudo swapoff -a
    sudo sed -i '/ swap / s/^/#/' /etc/fstab
    ```

3. **Load necessary kernel modules and configure sysctl:**

    ```sh
    cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
    br_netfilter
    EOF

    sudo modprobe br_netfilter

    cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
    net.bridge.bridge-nf-call-ip6tables = 1
    net.bridge.bridge-nf-call-iptables = 1
    net.ipv4.ip_forward = 1
    EOF

    sudo sysctl --system
    ```

## Step 2: Install Docker

1. **Install Docker:**

    ```sh
    sudo apt-get update
    sudo apt-get install -y docker.io
    ```

2. **Enable and start Docker:**

    ```sh
    sudo systemctl enable docker
    sudo systemctl start docker
    ```

## Step 3: Install Kubernetes Tools

1. **Add the Kubernetes apt repository:**

    ```sh
    curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
    sudo apt-add-repository "deb http://apt.kubernetes.io/ kubernetes-xenial main"
    ```

2. **Install kubeadm, kubelet, and kubectl:**

    ```sh
    sudo apt-get update
    sudo apt-get install -y kubelet kubeadm kubectl
    sudo apt-mark hold kubelet kubeadm kubectl
    ```

## Step 4: Initialize the Master Node

1. **Initialize the cluster:**

    ```sh
    sudo kubeadm init --pod-network-cidr=192.168.0.0/16 --apiserver-advertise-address=<master-node-ip>
    ```

2. **Set up local kubeconfig:**

    ```sh
    mkdir -p $HOME/.kube
    sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
    sudo chown $(id -u):$(id -g) $HOME/.kube/config
    ```

## Step 5: Install Calico Network Plugin

1. **Apply the Calico manifest:**

    ```sh
    kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
    ```

## Step 6: Join Worker Nodes to the Cluster

1. **On each worker node, run the join command generated by `kubeadm init`:**

    ```sh
    sudo kubeadm join <master-node-ip>:6443 --token <token> --discovery-token-ca-cert-hash sha256:<hash>
    ```

## Step 7: Verify the Cluster

1. **Check the status of nodes:**

    ```sh
    kubectl get nodes
    ```

2. **Check the status of pods:**

    ```sh
    kubectl get pods --all-namespaces
    ```

## Additional Steps

- **Deploy a sample application to test the setup:**

    ```sh
    kubectl create deployment nginx --image=nginx
    kubectl expose deployment nginx --port=80 --type=NodePort
    ```

- **Get the NodePort and access the application:**

    ```sh
    kubectl get service nginx
    ```

## Troubleshooting

- If any issues arise during the setup, refer to the [Kubeadm Troubleshooting Guide](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/).

## References

- [Kubernetes Documentation](https://kubernetes.io/docs/)
- [Calico Documentation](https://docs.projectcalico.org/)

---

This `README.md` file provides a comprehensive guide for setting up a Kubernetes cluster using `kubeadm` and configuring it with Calico. It covers all essential steps and includes commands to ensure a smooth installation process.
